<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beach Tennis Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Estilos Globais */
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; } /* Esconde todas as views por padrão */
        .view.active { display: block; } /* Mostra apenas a view ativa */

        /* Estilos para o Mata-Mata (Bracket) */
        .bracket-container { overflow-x: auto; padding: 20px 0; background-color: #f9fafb; border-radius: 12px; }
        .bracket { display: flex; justify-content: flex-start; min-width: max-content; }
        .round { display: flex; flex-direction: column; justify-content: space-around; width: 250px; margin: 0 30px; }
        .round-title { text-align: center; font-size: 1.1rem; font-weight: 700; color: #374151; margin-bottom: 20px; }
        .match { display: flex; flex-direction: column; background-color: white; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06); margin: 20px 0; position: relative; }
        .player { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-bottom: 1px solid #e5e7eb; }
        .player:last-child { border-bottom: none; }
        .player-name { font-size: .9rem; font-weight: 500; }
        .player-score { font-weight: bold; }
        .winner .player-name { font-weight: 700; color: #16a34a; }
        .match-connector { position: absolute; top: 50%; left: 100%; width: 30px; height: 2px; background-color: #d1d5db; }
        .match-connector-line { position: absolute; left: 0; width: 100%; height: 50%; border-color: #d1d5db; }
        .match-connector.up .match-connector-line { top: 0; border-width: 0 2px 2px 0; border-bottom-right-radius: 8px; }
        .match-connector.down .match-connector-line { bottom: 0; border-width: 2px 2px 0 0; border-top-right-radius: 8px; }

        /* Estilos para Modals e Toasts */
        #modal-backdrop {
            display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6);
            align-items: center; justify-content: center; z-index: 100;
        }
        #toast-container {
            position: fixed; bottom: 1.25rem; right: 1.25rem; z-index: 110;
            display: flex; flex-direction: column; gap: 0.75rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Container principal da aplicação -->
    <div id="app-root"></div>

    <!-- Container para Modals -->
    <div id="modal-backdrop">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md m-4">
            <!-- Conteúdo do modal será injetado aqui -->
        </div>
    </div>

    <!-- Container para Toasts -->
    <div id="toast-container"></div>


    <!-- ==================================================== -->
    <!-- TEMPLATES DAS PÁGINAS (VIEWS) -->
    <!-- ==================================================== -->

    <!-- Template: Página Pública (index.html) -->
    <template id="template-public-view">
        <div class="container mx-auto p-4 md:p-6">
            <header class="bg-white rounded-xl shadow-lg p-5 mb-6 flex justify-between items-center flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <i class="fas fa-table-tennis text-blue-600 text-4xl"></i>
                    <div>
                        <h1 class="text-3xl font-extrabold text-gray-800">Beach Tennis Manager</h1>
                        <p class="text-gray-500">Acompanhe os torneios e o ranking</p>
                    </div>
                </div>
                <div>
                    <a href="#admin/login" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        <i class="fas fa-user-shield mr-2"></i> Admin
                    </a>
                </div>
            </header>
            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <h2 class="text-3xl font-bold mb-6 text-gray-700">Torneios</h2>
                    <div id="public-tournaments-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <p class="text-gray-500 mt-4 col-span-full">Carregando torneios...</p>
                    </div>
                </div>
                <div>
                    <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 sticky top-6">
                        <h2 class="text-2xl font-bold mb-4 text-gray-700">Ranking Geral</h2>
                        <div class="overflow-y-auto max-h-96">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-800 text-white sticky top-0">
                                    <tr>
                                        <th class="w-1/12 text-left py-3 px-4 uppercase font-semibold text-sm">#</th>
                                        <th class="w-8/12 text-left py-3 px-4 uppercase font-semibold text-sm">Atleta</th>
                                        <th class="w-3/12 text-left py-3 px-4 uppercase font-semibold text-sm">Pts</th>
                                    </tr>
                                </thead>
                                <tbody id="ranking-table-body" class="text-gray-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </template>

    <!-- Template: Detalhes do Torneio (torneio.html) -->
    <template id="template-tournament-details-view">
        <div class="container mx-auto p-4 md:p-6">
            <div id="tournament-details-container" class="bg-white rounded-xl shadow-lg p-6">
                 <div class="text-center p-10"><i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i> Carregando...</div>
            </div>
        </div>
    </template>

    <!-- Template: Login do Admin (admin.html) -->
    <template id="template-admin-login-view">
         <div class="bg-gray-100 flex items-center justify-center min-h-screen">
            <div class="w-full max-w-md">
                <form id="login-form" class="bg-white shadow-lg rounded-xl px-8 pt-6 pb-8 mb-4">
                    <h1 class="text-3xl font-extrabold text-center mb-6">Login do Administrador</h1>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="login-email-input">Email</label>
                        <input class="shadow-sm appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" id="login-email-input" type="email" placeholder="admin@email.com" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="login-password-input">Senha</label>
                        <input class="shadow-sm appearance-none border rounded w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" id="login-password-input" type="password" placeholder="******************" required>
                    </div>
                    <p id="auth-error" class="text-red-500 text-sm mb-4 text-center h-4"></p>
                    <div class="flex items-center justify-between">
                        <button id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline disabled:opacity-50" type="submit">
                            Entrar
                        </button>
                    </div>
                    <div class="text-center mt-4">
                        <a href="#" class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800">Voltar para o site</a>
                    </div>
                </form>
            </div>
        </div>
    </template>

    <!-- Template: Layout Principal do Admin -->
    <template id="template-admin-layout">
        <div class="flex h-screen bg-gray-100">
            <!-- Barra Lateral -->
            <div class="hidden md:flex flex-col w-64 bg-white shadow-lg">
                <div class="flex items-center justify-center h-20 shadow-md">
                    <h1 class="text-2xl font-extrabold text-blue-600">Admin</h1>
                </div>
                <div class="flex flex-col flex-1 overflow-y-auto">
                    <nav class="flex-1 px-2 py-4 bg-white" id="admin-nav">
                        <a href="#admin/tournaments" data-nav="tournaments" class="flex items-center px-4 py-2 mt-2 text-gray-600 hover:bg-blue-100 hover:text-blue-700 rounded-lg"><i class="fas fa-trophy w-6 text-center"></i><span class="ml-3">Torneios</span></a>
                        <a href="#admin/athletes" data-nav="athletes" class="flex items-center px-4 py-2 mt-2 text-gray-600 hover:bg-blue-100 hover:text-blue-700 rounded-lg"><i class="fas fa-users w-6 text-center"></i><span class="ml-3">Atletas</span></a>
                        <a href="#admin/enrollments" data-nav="enrollments" class="flex items-center px-4 py-2 mt-2 text-gray-600 hover:bg-blue-100 hover:text-blue-700 rounded-lg"><i class="fas fa-user-plus w-6 text-center"></i><span class="ml-3">Inscrições</span></a>
                        <a href="#admin/matches" data-nav="matches" class="flex items-center px-4 py-2 mt-2 text-gray-600 hover:bg-blue-100 hover:text-blue-700 rounded-lg"><i class="fas fa-table-tennis w-6 text-center"></i><span class="ml-3">Partidas</span></a>
                    </nav>
                </div>
            </div>
            <!-- Conteúdo Principal -->
            <div class="flex flex-col flex-1 overflow-y-auto">
                <header class="flex items-center justify-between h-20 px-6 bg-white border-b">
                    <h1 id="admin-header-title" class="text-2xl font-bold text-gray-800"></h1>
                    <div class="flex items-center">
                        <span id="admin-email" class="text-sm font-semibold mr-4"></span>
                        <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Logout</button>
                    </div>
                </header>
                <main id="admin-content" class="p-6"></main>
            </div>
        </div>
    </template>
    
    <!-- Sub-Template: Gerenciar Torneios -->
    <template id="sub-template-admin-tournaments">
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h3 class="text-2xl font-bold mb-4">Criar Novo Torneio</h3>
            <form id="create-tournament-form" class="space-y-4">
                <input type="text" id="tournament-name" placeholder="Nome do Torneio" class="w-full p-3 border rounded-md" required>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <select id="tournament-type" class="w-full p-3 border rounded-md"><option value="1x1">Simples (1x1)</option><option value="2x2">Duplas (2x2)</option></select>
                    <select id="tournament-category" class="w-full p-3 border rounded-md"><option value="A">Cat. A</option><option value="B">Cat. B</option><option value="C">Cat. C</option><option value="D">Cat. D</option></select>
                    <select id="tournament-age" class="w-full p-3 border rounded-md"><option value="Adulto">Adulto</option><option value="Infantil">Infantil</option></select>
                    <select id="tournament-gender" class="w-full p-3 border rounded-md"><option value="Masculino">Masculino</option><option value="Feminino">Feminino</option><option value="Misto">Misto</option></select>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md">Criar Torneio</button>
            </form>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-2xl font-bold mb-4">Torneios Existentes</h3>
            <div id="admin-tournaments-list" class="space-y-3"></div>
        </div>
    </template>

    <!-- Sub-Template: Gerenciar Atletas -->
    <template id="sub-template-admin-athletes">
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h3 class="text-2xl font-bold mb-4">Adicionar Novo Atleta</h3>
            <form id="add-athlete-form" class="space-y-4">
                <label for="athlete-name" class="block font-medium">Nome do Atleta Individual</label>
                <input type="text" id="athlete-name" placeholder="Ex: João da Silva" class="w-full p-3 border rounded-md" required>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md">Adicionar à Lista Global</button>
            </form>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-2xl font-bold mb-4">Lista de Atletas Globais</h3>
            <div id="global-athletes-list" class="space-y-2"></div>
        </div>
    </template>

    <!-- Sub-Template: Gerenciar Inscrições -->
    <template id="sub-template-admin-enrollments">
         <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="space-y-4 bg-gray-50 p-6 rounded-lg border mb-8">
                <label for="enrollment-tournament-select" class="block font-medium">Selecione um Torneio (apenas com inscrições abertas):</label>
                <select id="enrollment-tournament-select" class="w-full p-3 border rounded-md"></select>
            </div>
            <div id="enrollment-management-area" class="mt-6 hidden">
                <div id="enrollment-form-container" class="bg-blue-50 p-6 rounded-lg border-l-4 border-blue-500 mb-8"></div>
                <div>
                    <h4 class="text-xl font-bold mb-4">Inscritos no Torneio</h4>
                    <div id="enrolled-list" class="space-y-2"></div>
                </div>
            </div>
         </div>
    </template>

    <!-- Sub-Template: Gerenciar Partidas -->
    <template id="sub-template-admin-matches">
         <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="space-y-4 bg-gray-50 p-6 rounded-lg border mb-8">
                <label for="match-tournament-select" class="block font-medium">Selecione um Torneio:</label>
                <select id="match-tournament-select" class="w-full p-3 border rounded-md"></select>
            </div>
            <div id="match-management-area" class="mt-6 hidden">
                <div id="tournament-controls" class="flex justify-center gap-4 mb-8"></div>
                <div id="matches-list-container" class="space-y-6"></div>
            </div>
         </div>
    </template>


    <!-- ==================================================== -->
    <!-- SCRIPT PRINCIPAL DA APLICAÇÃO -->
    <!-- ==================================================== -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, 
            onSnapshot, query, where, orderBy, serverTimestamp, writeBatch, increment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDEiEknWaOl2ra-it2dB8mFGPb9-Q__5-E",
            authDomain: "beachp4-70588.firebaseapp.com",
            projectId: "beachp4-70588",
            storageBucket: "beachp4-70588.appspot.com",
            messagingSenderId: "960018980292",
            appId: "1:960018980292:web:a11dbdd40811dec1ee5891"
        };

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State global da aplicação
        const state = {
            currentUser: null,
            authReady: false, // Flag para saber se a verificação inicial de auth terminou
            currentListeners: [],
            currentTournamentId: null,
        };

        // Elemento raiz onde as views são renderizadas
        const appRoot = document.getElementById('app-root');

        // ==================================
        // UTILS (Funções Utilitárias)
        // ==================================

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            toast.className = `p-4 rounded-lg shadow-xl text-white ${bgColor} transition-all duration-300 transform translate-y-10 opacity-0`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.remove('translate-y-10', 'opacity-0'), 10);
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        }

        function showConfirmationModal(title, message) {
            return new Promise(resolve => {
                const modalBackdrop = document.getElementById('modal-backdrop');
                const modalContent = document.getElementById('modal-content');
                modalContent.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">${title}</h3>
                    <p class="text-gray-600 mb-6">${message}</p>
                    <div class="flex justify-end space-x-4">
                        <button id="modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                        <button id="modal-confirm-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button>
                    </div>`;
                modalBackdrop.style.display = 'flex';
                document.getElementById('modal-confirm-btn').onclick = () => { modalBackdrop.style.display = 'none'; resolve(true); };
                document.getElementById('modal-cancel-btn').onclick = () => { modalBackdrop.style.display = 'none'; resolve(false); };
            });
        }
        
        function openModal(innerHTML) {
            document.getElementById('modal-content').innerHTML = innerHTML;
            document.getElementById('modal-backdrop').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-backdrop').style.display = 'none';
        }
        window.closeModal = closeModal;

        function cleanupListeners() {
            state.currentListeners.forEach(unsubscribe => unsubscribe());
            state.currentListeners = [];
        }

        function addListener(unsubscribe) {
            state.currentListeners.push(unsubscribe);
        }
        
        // ==================================
        // ROUTER (Gerenciador de Rotas/Views)
        // ==================================

        const routes = {
            '': { template: 'public-view', init: initPublicPage },
            'tournament-details': { template: 'tournament-details-view', init: initTournamentDetailsPage },
            'admin/login': { template: 'admin-login-view', init: initAdminLoginPage },
            'admin/tournaments': { template: 'admin-layout', init: initAdminLayout, requiresAuth: true },
            'admin/athletes': { template: 'admin-layout', init: initAdminLayout, requiresAuth: true },
            'admin/enrollments': { template: 'admin-layout', init: initAdminLayout, requiresAuth: true },
            'admin/matches': { template: 'admin-layout', init: initAdminLayout, requiresAuth: true },
        };

        const adminSubRoutes = {
            'tournaments': { title: 'Gerenciar Torneios', template: 'sub-template-admin-tournaments', init: initAdminTournamentsPage },
            'athletes': { title: 'Gerenciar Atletas', template: 'sub-template-admin-athletes', init: initAdminAthletesPage },
            'enrollments': { title: 'Gerenciar Inscrições', template: 'sub-template-admin-enrollments', init: initAdminEnrollmentsPage },
            'matches': { title: 'Gerenciar Partidas', template: 'sub-template-admin-matches', init: initAdminMatchesPage },
        };
        
        function navigate() {
            if (!state.authReady) return; // Não navega antes da auth estar pronta

            cleanupListeners();
            const path = window.location.hash.slice(1) || '';
            const [baseRoute] = path.split('?');

            // Encontra a rota correspondente, ou a rota default
            const route = routes[baseRoute] || routes[''];

            // ---- Lógica de Proteção de Rota ----
            const isAuthenticated = !!state.currentUser;

            if (route.requiresAuth && !isAuthenticated) {
                window.location.hash = '#admin/login';
                return;
            }
            if (baseRoute === 'admin/login' && isAuthenticated) {
                window.location.hash = '#admin/tournaments';
                return;
            }
            
            // Renderiza o template da rota
            const template = document.getElementById(`template-${route.template}`);
            if (!template) {
                appRoot.innerHTML = '<p class="text-center text-red-500 p-8">Erro 404: Página não encontrada.</p>';
                return;
            }
            appRoot.innerHTML = '';
            appRoot.appendChild(template.content.cloneNode(true));
            
            // Inicializa a lógica da página
            route.init();
        }
        
        window.addEventListener('hashchange', navigate);

        // ==================================
        // AUTH (Autenticação)
        // ==================================
        
        onAuthStateChanged(auth, (user) => {
            state.currentUser = user;
            // Marca que a verificação inicial terminou e inicia a navegação
            if (!state.authReady) {
                state.authReady = true;
                navigate();
            }
        });

        function initAdminLoginPage() {
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const button = document.getElementById('login-button');
                    const originalText = button.innerHTML;
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Entrando...';

                    const email = document.getElementById('login-email-input').value;
                    const password = document.getElementById('login-password-input').value;
                    const errorEl = document.getElementById('auth-error');
                    errorEl.textContent = '';

                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        // A mudança de estado no onAuthStateChanged vai acionar a navegação correta
                        // Forçamos uma navegação para o caso de o hash já ser o de login
                        window.location.hash = '#admin/tournaments';

                    } catch (error) {
                        switch (error.code) {
                            case 'auth/invalid-email':
                            case 'auth/user-not-found':
                            case 'auth/wrong-password':
                            case 'auth/invalid-credential':
                                errorEl.textContent = "Email ou senha inválidos.";
                                break;
                            default:
                                errorEl.textContent = "Ocorreu um erro ao tentar fazer login.";
                                break;
                        }
                    } finally {
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }
                });
            }
            const backLink = document.querySelector('a[href="#"]');
            if (backLink) {
                 backLink.onclick = (e) => { e.preventDefault(); window.location.hash = ''; }
            }
        }

        function initAdminLayout() {
            if (!state.currentUser) return;

            document.getElementById('admin-email').textContent = state.currentUser.email;
            document.getElementById('logout-btn').addEventListener('click', () => {
                signOut(auth).then(() => {
                    window.location.hash = '#admin/login';
                });
            });

            const path = window.location.hash.slice(1) || '';
            const subRouteKey = path.split('/')[1] || 'tournaments';
            const subRoute = adminSubRoutes[subRouteKey];

            if (subRoute) {
                document.getElementById('admin-header-title').textContent = subRoute.title;
                const contentArea = document.getElementById('admin-content');
                const subTemplate = document.getElementById(subRoute.template);
                if (contentArea && subTemplate) {
                    contentArea.innerHTML = '';
                    contentArea.appendChild(subTemplate.content.cloneNode(true));
                    
                    document.querySelectorAll('#admin-nav a').forEach(a => a.classList.remove('bg-blue-600', 'text-white'));
                    const activeLink = document.querySelector(`#admin-nav a[data-nav="${subRouteKey}"]`);
                    if(activeLink) activeLink.classList.add('bg-blue-600', 'text-white');
    
                    subRoute.init();
                }
            }
        }
        
        // ==================================
        // VIEW: Página Pública
        // ==================================
        function initPublicPage() {
            const tournamentsListEl = document.getElementById('public-tournaments-list');
            const rankingTableBody = document.getElementById('ranking-table-body');
            
            const qTournaments = query(collection(db, "tournaments"), orderBy("createdAt", "desc"));
            const unsubTournaments = onSnapshot(qTournaments, (snapshot) => {
                if (!tournamentsListEl) return;
                if (snapshot.empty) {
                    tournamentsListEl.innerHTML = '<p class="text-gray-500 mt-4 col-span-full">Nenhum torneio encontrado no momento.</p>';
                    return;
                }
                tournamentsListEl.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const statusInfo = getStatusInfo(data.status);
                    return `
                        <a href="#tournament-details?id=${doc.id}" class="bg-white block p-6 rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all">
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-xl mb-2 text-blue-800">${data.name}</h3>
                                <span class="text-xs font-semibold px-2.5 py-1 rounded-full ${statusInfo.style}">${statusInfo.text}</span>
                            </div>
                            <p class="text-gray-600 text-sm"><i class="fas fa-tags mr-2 opacity-60"></i> ${data.category} / ${data.gender} / ${data.age}</p>
                            <p class="text-gray-600 text-sm"><i class="fas fa-info-circle mr-2 opacity-60"></i> ${data.type === '1x1' ? 'Simples' : 'Duplas'}</p>
                        </a>`;
                }).join('');
            });
            addListener(unsubTournaments);
            
            const qRanking = query(collection(db, "ranking"), orderBy("points", "desc"));
            const unsubRanking = onSnapshot(qRanking, (snapshot) => {
                if(!rankingTableBody) return;
                rankingTableBody.innerHTML = snapshot.docs.map((doc, i) => `
                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="py-3 px-4 font-bold">${i + 1}</td>
                        <td class="py-3 px-4">${doc.id}</td>
                        <td class="py-3 px-4 font-semibold">${doc.data().points}</td>
                    </tr>
                `).join('');
            });
            addListener(unsubRanking);
        }
        
        function getStatusInfo(status) {
            const styles = {
                'Inscrições Abertas': 'bg-blue-100 text-blue-800',
                'Fase de Grupos': 'bg-yellow-100 text-yellow-800',
                'Mata-Mata': 'bg-purple-100 text-purple-800',
                'Finalizado': 'bg-green-100 text-green-800'
            };
            return { text: status, style: styles[status] || 'bg-gray-100 text-gray-800' };
        }

        // ==================================
        // VIEW: Detalhes do Torneio
        // ==================================
        function initTournamentDetailsPage() {
            const params = new URLSearchParams(window.location.hash.split('?')[1]);
            const tournamentId = params.get('id');
            const container = document.getElementById('tournament-details-container');

            if (!tournamentId) {
                container.innerHTML = '<p class="text-center text-red-500">ID do torneio não fornecido.</p>';
                return;
            }
            
            const unsub = onSnapshot(doc(db, "tournaments", tournamentId), (docSnapshot) => {
                if (!container) return;
                if (!docSnapshot.exists()) {
                    container.innerHTML = '<p class="text-center text-red-500">Torneio não encontrado.</p>';
                    return;
                }
                const tournament = docSnapshot.data();
                renderTournamentDetails(container, tournament);
                listenToMatchesForDetails(tournament.status, tournamentId);
            });
            addListener(unsub);
        }

        function renderTournamentDetails(container, tournament) {
             const statusInfo = getStatusInfo(tournament.status);
             container.innerHTML = `
                <a href="#" onclick="window.history.back(); return false;" class="inline-block mb-6 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg"><i class="fas fa-arrow-left mr-2"></i>Voltar</a>
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-800">${tournament.name}</h2>
                    <span class="text-sm font-semibold px-3 py-1.5 rounded-full ${statusInfo.style}">${statusInfo.text}</span>
                </div>
                ${tournament.status === 'Finalizado' && tournament.winner ? `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg mb-6"><p class="font-bold text-lg"><i class="fas fa-crown mr-2"></i>Campeão: ${tournament.winner.name}</p></div>` : ''}
                <div id="tournament-content-area" class="space-y-8"></div>
             `;
        }

        function listenToMatchesForDetails(status, tournamentId) {
             const q = query(collection(db, `tournaments/${tournamentId}/matches`), orderBy("round"), orderBy("group"));
             const unsub = onSnapshot(q, (snapshot) => {
                const area = document.getElementById('tournament-content-area');
                if(!area) return;
                
                if (snapshot.empty) {
                    area.innerHTML = '<p class="text-gray-500 mt-8 text-center">As partidas ainda não foram geradas.</p>';
                    return;
                }

                const matches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (status === 'Fase de Grupos') {
                    area.innerHTML = renderGroupStageView(matches);
                } else if (status === 'Mata-Mata' || status === 'Finalizado') {
                    area.innerHTML = renderBracketView(matches);
                }
            });
            addListener(unsub);
        }

        function renderGroupStageView(matches) {
            const groups = {};
            matches.forEach(m => { 
                if (m.stage !== 'Grupos') return;
                if (!groups[m.group]) groups[m.group] = []; 
                groups[m.group].push(m); 
            });
            let html = '<h3 class="text-2xl font-bold text-gray-700 mb-4">Fase de Grupos</h3>';
            Object.keys(groups).sort().forEach(name => {
                html += `<div class="mb-6"><h4 class="text-xl font-bold p-3 bg-blue-100 text-blue-800 rounded-t-lg">${name}</h4><div class="border border-t-0 rounded-b-lg p-4 space-y-3">`;
                groups[name].forEach(m => {
                    const score = m.status === 'Finalizado' ? `<span class="font-bold text-lg text-green-600">${m.score1} x ${m.score2}</span>` : `<span class="text-sm font-medium text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full">Pendente</span>`;
                    html += `<div class="flex flex-col sm:flex-row justify-between items-center p-3 rounded-lg bg-gray-50 border"><div>${m.player1.name} <span class="text-gray-400 mx-2">vs</span> ${m.player2.name}</div><div>${score}</div></div>`;
                });
                html += `</div></div>`;
            });
            return html;
        }

        function renderBracketView(matches) {
             const rounds = {};
             const roundOrder = ['Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'];
             matches.forEach(m => { 
                 if (m.stage === 'Grupos') return;
                 if (!rounds[m.stage]) rounds[m.stage] = [];
                 rounds[m.stage].push(m);
             });
             
             let html = '<h3 class="text-2xl font-bold text-gray-700 mb-4">Mata-Mata</h3><div class="bracket-container"><div class="bracket">';
             roundOrder.forEach(name => {
                 if(!rounds[name] || rounds[name].length === 0) return;
                 rounds[name].forEach(match => match.round = roundOrder.indexOf(match.stage));
                 rounds[name].sort((a,b) => a.matchNumber - b.matchNumber);
                 
                 html += `<div class="round"><div class="round-title">${name}</div>`;
                 rounds[name].forEach((m, i) => {
                     const p1Win = m.score1 > m.score2, p2Win = m.score2 > m.score1;
                     const p1Name = m.player1.name || 'A definir';
                     const p2Name = m.player2.name || 'A definir';
                     html += `<div class="match"><div class="match-content">
                                <div class="player ${p1Win?'winner':''}"><span class="player-name">${p1Name}</span><span class="player-score">${m.score1 ?? ''}</span></div>
                                <div class="player ${p2Win?'winner':''}"><span class="player-name">${p2Name}</span><span class="player-score">${m.score2 ?? ''}</span></div>
                              </div>
                              ${name !=='Final' ? `<div class="match-connector ${i%2===0?'up':'down'}"><div class="match-connector-line"></div></div>` : ''}
                              </div>`;
                 });
                 html += `</div>`;
             });
             return html + '</div></div>';
        }

        // ==================================
        // ADMIN VIEWS
        // ==================================
        
        function initAdminTournamentsPage() {
            const form = document.getElementById('create-tournament-form');
            if (!form) return;
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await addDoc(collection(db, "tournaments"), {
                        name: document.getElementById('tournament-name').value,
                        type: document.getElementById('tournament-type').value,
                        category: document.getElementById('tournament-category').value,
                        age: document.getElementById('tournament-age').value,
                        gender: document.getElementById('tournament-gender').value,
                        status: 'Inscrições Abertas',
                        createdAt: serverTimestamp()
                    });
                    form.reset();
                    showToast("Torneio criado com sucesso!");
                } catch (error) {
                    showToast("Erro ao criar torneio.", "error");
                }
            });

            const listEl = document.getElementById('admin-tournaments-list');
            const q = query(collection(db, "tournaments"), orderBy("createdAt", "desc"));
            const unsub = onSnapshot(q, (snapshot) => {
                if (!listEl) return;
                if (snapshot.empty) {
                    listEl.innerHTML = '<p>Nenhum torneio criado ainda.</p>';
                    return;
                }
                listEl.innerHTML = snapshot.docs.map(doc => `
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border">
                        <div>
                            <p class="font-semibold">${doc.data().name}</p>
                            <p class="text-sm text-gray-600">${doc.data().category} - ${doc.data().type === '1x1' ? 'Simples' : 'Duplas'} - <span class="font-medium">${doc.data().status}</span></p>
                        </div>
                        <button onclick="deleteTournament('${doc.id}', '${doc.data().name}')" class="text-red-500 hover:text-red-700 font-bold py-1 px-3 rounded"><i class="fas fa-trash"></i></button>
                    </div>`).join('');
            });
            addListener(unsub);
        }

        async function deleteTournament(id, name) {
            const confirmed = await showConfirmationModal(
                'Apagar Torneio?', 
                `Tem certeza que deseja apagar "${name}"? Todas as inscrições e partidas serão apagadas permanentemente.`
            );
            if (!confirmed) return;

            try {
                const batch = writeBatch(db);
                const playersSnap = await getDocs(collection(db, `tournaments/${id}/players`));
                playersSnap.forEach(doc => batch.delete(doc.ref));
                const matchesSnap = await getDocs(collection(db, `tournaments/${id}/matches`));
                matchesSnap.forEach(doc => batch.delete(doc.ref));
                batch.delete(doc(db, "tournaments", id));
                await batch.commit();
                showToast("Torneio apagado com sucesso.");
            } catch (error) {
                showToast("Erro ao apagar torneio.", "error");
            }
        }
        window.deleteTournament = deleteTournament;

        function initAdminAthletesPage() {
            const form = document.getElementById('add-athlete-form');
            if (!form) return;
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('athlete-name');
                const name = nameInput.value.trim();
                if (!name) return;
                try {
                    await setDoc(doc(db, "ranking", name), { name, points: 0, createdAt: serverTimestamp() }, { merge: true });
                    nameInput.value = '';
                    showToast("Atleta adicionado com sucesso!");
                } catch (error) {
                    showToast("Erro ao adicionar atleta.", "error");
                }
            });

            const listEl = document.getElementById('global-athletes-list');
            const q = query(collection(db, "ranking"), orderBy("name"));
            const unsub = onSnapshot(q, (snapshot) => {
                if (!listEl) return;
                if (snapshot.empty) {
                    listEl.innerHTML = '<p>Nenhum atleta cadastrado.</p>';
                    return;
                }
                listEl.innerHTML = snapshot.docs.map(doc => `
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border">
                        <span class="font-medium">${doc.data().name}</span>
                        <button onclick="deleteGlobalAthlete('${doc.id}')" class="text-red-500 hover:text-red-700 font-bold py-1 px-3 rounded"><i class="fas fa-trash"></i></button>
                    </div>`).join('');
            });
            addListener(unsub);
        }
        
        async function deleteGlobalAthlete(id) {
            const confirmed = await showConfirmationModal('Remover Atleta?', `Remover "${id}" da lista global e do ranking? Isso não o removerá de torneios onde já está inscrito.`);
            if (confirmed) {
                try {
                    await deleteDoc(doc(db, "ranking", id));
                    showToast("Atleta removido com sucesso.");
                } catch (error) {
                    showToast("Erro ao remover atleta.", "error");
                }
            }
        }
        window.deleteGlobalAthlete = deleteGlobalAthlete;

        function initAdminEnrollmentsPage() {
            const selectEl = document.getElementById('enrollment-tournament-select');
            if (!selectEl) return;
            const q = query(collection(db, "tournaments"), where("status", "==", "Inscrições Abertas"), orderBy("createdAt", "desc"));
            const unsub = onSnapshot(q, (snapshot) => {
                selectEl.innerHTML = '<option value="">Selecione um torneio...</option>';
                snapshot.forEach(doc => {
                    selectEl.innerHTML += `<option value="${doc.id}" data-type="${doc.data().type}">${doc.data().name}</option>`;
                });
            });
            addListener(unsub);

            selectEl.addEventListener('change', (e) => {
                const selectedOption = e.target.options[e.target.selectedIndex];
                state.currentTournamentId = e.target.value;
                const tournamentType = selectedOption.getAttribute('data-type');
                
                document.getElementById('enrollment-management-area').classList.toggle('hidden', !state.currentTournamentId);
                
                if (state.currentTournamentId) {
                    listenToEnrollments(tournamentType);
                }
            });
        }
        
        function listenToEnrollments(tournamentType) {
            const formContainer = document.getElementById('enrollment-form-container');
            const enrolledListEl = document.getElementById('enrolled-list');
            
            cleanupListeners();
            const unsub1 = onSnapshot(collection(db, "ranking"), (allAthletesSnap) => {
                const unsub2 = onSnapshot(collection(db, `tournaments/${state.currentTournamentId}/players`), (enrolledAthletesSnap) => {
                    if (!formContainer || !enrolledListEl) return;
                    const allAthletes = allAthletesSnap.docs.map(d => d.id);
                    const enrolledData = enrolledAthletesSnap.docs.map(d => ({id: d.id, ...d.data()}));
                    
                    let enrolledIndividuals = [];
                    enrolledData.forEach(p => {
                        if (p.type === 'single') enrolledIndividuals.push(p.id);
                        else if (p.type === 'double') enrolledIndividuals.push(...p.players);
                    });
                    
                    const availableAthletes = allAthletes.filter(name => !enrolledIndividuals.includes(name));
                    
                    renderEnrollmentForm(formContainer, availableAthletes, tournamentType);
                    enrolledListEl.innerHTML = enrolledData.length > 0
                        ? enrolledData.map(player => `<div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border">
                            <span class="font-medium">${player.id}</span>
                            <button onclick="unenroll('${player.id}')" class="text-red-500 hover:text-red-700 font-bold py-1 px-3 rounded"><i class="fas fa-trash-alt"></i></button>
                            </div>`).join('')
                        : '<p>Nenhum inscrito ainda.</p>';
                });
                addListener(unsub2);
            });
            addListener(unsub1);
        }

        function renderEnrollmentForm(container, availableAthletes, type) {
            let options = availableAthletes.map(name => `<option value="${name}">${name}</option>`).join('');
            if (type === '1x1') {
                container.innerHTML = `<form id="enroll-form" class="flex gap-2 items-center">
                        <select class="w-full p-3 border rounded-md" required>${options}</select>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-md">Inscrever</button>
                    </form>`;
            } else {
                container.innerHTML = `<form id="enroll-form" class="space-y-3">
                        <p class="font-semibold">Formar Dupla</p>
                        <div><label for="p1" class="text-sm">Atleta 1:</label><select id="p1" class="w-full p-3 border rounded-md mt-1" required>${options}</select></div>
                        <div><label for="p2" class="text-sm">Atleta 2:</label><select id="p2" class="w-full p-3 border rounded-md mt-1" required>${options}</select></div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-md font-bold">Inscrever Dupla</button>
                    </form>`;
            }
            const form = document.getElementById('enroll-form');
            if (form) form.addEventListener('submit', handleEnrollmentSubmit);
        }

        async function handleEnrollmentSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const type = form.querySelector('#p1') ? '2x2' : '1x1';
            if (type === '1x1') {
                const name = form.querySelector('select').value;
                if(name) {
                    const playerData = { name: name, type: 'single', id: name };
                    await setDoc(doc(db, `tournaments/${state.currentTournamentId}/players`, name), playerData);
                }
            } else {
                const p1 = document.getElementById('p1').value;
                const p2 = document.getElementById('p2').value;
                if(p1 && p2 && p1 !== p2) {
                    const pairName = [p1, p2].sort().join(' / ');
                    const pairData = { name: pairName, type: 'double', players: [p1, p2], id: pairName };
                    await setDoc(doc(db, `tournaments/${state.currentTournamentId}/players`, pairName), pairData);
                } else {
                    showToast("Selecione dois atletas diferentes.", "error");
                }
            }
        }

        async function unenroll(playerId) {
            if (await showConfirmationModal('Remover Inscrição?', `Remover "${playerId}" deste torneio?`)) {
                 await deleteDoc(doc(db, `tournaments/${state.currentTournamentId}/players`, playerId));
                 showToast("Inscrição removida.");
            }
        }
        window.unenroll = unenroll;

        // ==================================
        // ADMIN VIEW: Gerenciar Partidas
        // ==================================
        function initAdminMatchesPage() {
            const selectEl = document.getElementById('match-tournament-select');
            if (!selectEl) return;
            const q = query(collection(db, "tournaments"), orderBy("createdAt", "desc"));
            const unsub = onSnapshot(q, (snapshot) => {
                const currentVal = selectEl.value;
                selectEl.innerHTML = '<option value="">Selecione um torneio...</option>';
                snapshot.forEach(doc => {
                    selectEl.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`;
                });
                if(currentVal) selectEl.value = currentVal;
            });
            addListener(unsub);

            selectEl.addEventListener('change', (e) => {
                state.currentTournamentId = e.target.value;
                document.getElementById('match-management-area').classList.toggle('hidden', !state.currentTournamentId);
                if(state.currentTournamentId) {
                    listenToTournamentState();
                }
            });
        }
        
        function listenToTournamentState() {
            cleanupListeners();
            const unsub = onSnapshot(doc(db, "tournaments", state.currentTournamentId), (docSnap) => {
                if (docSnap.exists()) {
                    renderTournamentControls(docSnap.data().status);
                    renderMatchesList();
                }
            });
            addListener(unsub);
        }
        
        function renderTournamentControls(status) {
            const container = document.getElementById('tournament-controls');
            if(!container) return;
            const buttons = {
                'Inscrições Abertas': `<button onclick="generateGroupStage()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">Iniciar Fase de Grupos</button>`,
                'Fase de Grupos': `<button onclick="generateKnockoutStage()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">Iniciar Mata-Mata</button>`,
                'Mata-Mata': `<button onclick="finishTournament()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">Finalizar Torneio e Pontuar</button>`,
                'Finalizado': `<p class="text-center font-semibold text-green-700 col-span-full">Este torneio foi finalizado.</p>`
            };
            container.innerHTML = buttons[status] || '';
        }
        
        function renderMatchesList() {
            const listContainer = document.getElementById('matches-list-container');
            if(!listContainer) return;
            const q = query(collection(db, `tournaments/${state.currentTournamentId}/matches`), orderBy("round"), orderBy("group"));
            const unsub = onSnapshot(q, (snapshot) => {
                if(!listContainer) return;
                listContainer.innerHTML = '';
                if(snapshot.empty) {
                    listContainer.innerHTML = '<p class="text-gray-500">Nenhuma partida gerada para este torneio.</p>';
                    return;
                }
                const matchesByStage = {};
                snapshot.docs.forEach(d => {
                    const match = {id: d.id, ...d.data()};
                    const stageName = match.stage === 'Grupos' ? match.group : match.stage;
                    if(!matchesByStage[stageName]) matchesByStage[stageName] = [];
                    matchesByStage[stageName].push(match);
                });

                Object.keys(matchesByStage).sort((a,b) => (a.startsWith("Grupo") ? -1 : 1)).forEach(stageName => { // Grupos primeiro
                    let sectionHTML = `<h4 class="text-xl font-bold mt-4 mb-2 p-3 bg-gray-200 rounded-lg">${stageName}</h4>`;
                    matchesByStage[stageName].forEach(match => {
                        const scoreText = match.status === 'Finalizado' ? `<b>${match.score1} x ${match.score2}</b>` : 'Pendente';
                        const p1Name = match.player1.name || 'A definir';
                        const p2Name = match.player2.name || 'A definir';
                        const canUpdate = match.status !== 'Finalizado' && p1Name !== 'A definir' && p2Name !== 'A definir' && p1Name !== 'BYE' && p2Name !== 'BYE';
                        sectionHTML += `
                            <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border">
                                <div>
                                    <span>${p1Name} vs ${p2Name}</span>
                                    <span class="ml-4 text-sm text-gray-600 font-semibold">${scoreText}</span>
                                </div>
                                ${canUpdate ? `<button onclick="openScoreModal('${match.id}', '${match.stage}', '${p1Name}', '${p2Name}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">Placar</button>` : ''}
                            </div>`;
                    });
                     listContainer.innerHTML += sectionHTML;
                });
            });
            addListener(unsub);
        }

        function openScoreModal(matchId, stage, p1, p2) {
            const modalHTML = `
                <h3 class="text-xl font-bold mb-6">Atualizar Placar</h3>
                <form id="update-score-form">
                    <input type="hidden" id="modal-match-id" value="${matchId}">
                    <div class="grid grid-cols-2 gap-4 items-end">
                        <div class="text-center">
                            <label class="block font-semibold mb-2">${p1}</label>
                            <input type="number" id="player1-score" class="w-full p-3 text-center text-2xl font-bold border rounded-md" min="0" required>
                        </div>
                        <div class="text-center">
                            <label class="block font-semibold mb-2">${p2}</label>
                            <input type="number" id="player2-score" class="w-full p-3 text-center text-2xl font-bold border rounded-md" min="0" required>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end space-x-4">
                        <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Salvar Placar</button>
                    </div>
                </form>
            `;
            openModal(modalHTML);
            document.getElementById('update-score-form').addEventListener('submit', updateScore);
        }
        window.openScoreModal = openScoreModal;
        
        async function updateScore(e) {
            e.preventDefault();
            const s1 = parseInt(document.getElementById('player1-score').value);
            const s2 = parseInt(document.getElementById('player2-score').value);
            if (s1 === s2) { showToast("Empates não são permitidos.", "error"); return; }
            
            const mId = document.getElementById('modal-match-id').value;
            const matchRef = doc(db, `tournaments/${state.currentTournamentId}/matches`, mId);
            const matchDoc = await getDoc(matchRef);
            const matchData = matchDoc.data();
            
            await updateDoc(matchRef, { score1: s1, score2: s2, status: 'Finalizado' });
            
            if (matchData.stage !== 'Grupos') {
                await advanceWinner(state.currentTournamentId, mId);
            }
            closeModal();
            showToast("Placar atualizado!");
        }

        async function advanceWinner(tId, finishedMatchId) {
            const matchDoc = await getDoc(doc(db, `tournaments/${tId}/matches`, finishedMatchId));
            if(!matchDoc.exists()) return;

            const matchData = matchDoc.data();
            const winner = matchData.score1 > matchData.score2 ? matchData.player1 : matchData.player2;
            
            if (matchData.stage === 'Final') {
                await updateDoc(doc(db, "tournaments", tId), { winner: winner });
                return;
            }

            const q = query(collection(db, `tournaments/${tId}/matches`), where("dependsOn", "array-contains", finishedMatchId));
            const nextMatchesSnap = await getDocs(q);

            if (!nextMatchesSnap.empty) {
                const nextMatchDoc = nextMatchesSnap.docs[0];
                const nextMatchData = nextMatchDoc.data();
                
                const playerPos = nextMatchData.player1.from === finishedMatchId ? 'player1' : 'player2';
                
                await updateDoc(nextMatchDoc.ref, { [playerPos]: winner });
            }
        }

        // ==================================
        // LÓGICA DO TORNEIO
        // ==================================
        
        const groupFormationRules = {
            3: { groups: 1, p_per_group: [3] }, 4: { groups: 1, p_per_group: [4] }, 5: { groups: 1, p_per_group: [5] },
            6: { groups: 2, p_per_group: [3, 3] }, 7: { groups: 2, p_per_group: [4, 3] }, 8: { groups: 2, p_per_group: [4, 4] },
            9: { groups: 3, p_per_group: [3, 3, 3] }, 10: { groups: 3, p_per_group: [4, 3, 3] }, 11: { groups: 3, p_per_group: [4, 4, 3] },
            12: { groups: 4, p_per_group: [3, 3, 3, 3] }, 13: { groups: 4, p_per_group: [4, 3, 3, 3] }, 14: { groups: 4, p_per_group: [4, 4, 3, 3] },
            15: { groups: 5, p_per_group: [3, 3, 3, 3, 3] }, 16: { groups: 4, p_per_group: [4, 4, 4, 4] },
            17: { groups: 5, p_per_group: [4, 4, 3, 3, 3] }, 18: { groups: 6, p_per_group: [3,3,3,3,3,3]},
        };

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        async function generateGroupStage() {
            const confirmed = await showConfirmationModal('Iniciar Fase de Grupos?', 'Isso fechará as inscrições e gerará as partidas. Esta ação não pode ser desfeita.');
            if (!confirmed) return;

            const playersSnap = await getDocs(collection(db, `tournaments/${state.currentTournamentId}/players`));
            if (playersSnap.docs.length < 3) {
                showToast("É necessário ter pelo menos 3 inscritos.", "error");
                return;
            }
            let players = playersSnap.docs.map(doc => doc.data());
            shuffleArray(players);

            const rule = groupFormationRules[players.length];
            if (!rule) {
                showToast(`Formato para ${players.length} inscritos não definido.`, "error");
                return;
            }

            const batch = writeBatch(db);
            let playerIndex = 0;
            for (let i = 0; i < rule.groups; i++) {
                const groupName = `Grupo ${String.fromCharCode(65 + i)}`;
                const groupSize = rule.p_per_group[i];
                const groupPlayers = players.slice(playerIndex, playerIndex + groupSize);
                playerIndex += groupSize;

                for (let j = 0; j < groupPlayers.length; j++) {
                    for (let k = j + 1; k < groupPlayers.length; k++) {
                        const matchData = {
                            player1: { id: groupPlayers[j].id, name: groupPlayers[j].name },
                            player2: { id: groupPlayers[k].id, name: groupPlayers[k].name },
                            stage: 'Grupos',
                            group: groupName,
                            round: 0, 
                            status: 'Pendente',
                            score1: null,
                            score2: null,
                        };
                        const matchRef = doc(collection(db, `tournaments/${state.currentTournamentId}/matches`));
                        batch.set(matchRef, matchData);
                    }
                }
            }
            
            batch.update(doc(db, "tournaments", state.currentTournamentId), { status: "Fase de Grupos" });
            await batch.commit();
            showToast("Fase de Grupos iniciada com sucesso!");
        }
        window.generateGroupStage = generateGroupStage;
        
        async function generateKnockoutStage() {
            const confirmed = await showConfirmationModal('Iniciar Mata-Mata?', 'Todos os jogos da fase de grupo devem estar finalizados. Esta ação não pode ser desfeita.');
            if (!confirmed) return;
            
            const matchesSnap = await getDocs(collection(db, `tournaments/${state.currentTournamentId}/matches`));
            const matches = matchesSnap.docs.map(d => ({id: d.id, ...d.data()}));
            const groupMatches = matches.filter(m => m.stage === 'Grupos');

            if (groupMatches.some(m => m.status !== 'Finalizado')) {
                showToast("Ainda existem partidas pendentes na Fase de Grupos.", "error");
                return;
            }
            
            const standings = {}; 
            groupMatches.forEach(m => {
                if (!standings[m.player1.id]) standings[m.player1.id] = { wins: 0, gamesFor: 0, gamesAgainst: 0, group: m.group, name: m.player1.name, id: m.player1.id };
                if (!standings[m.player2.id]) standings[m.player2.id] = { wins: 0, gamesFor: 0, gamesAgainst: 0, group: m.group, name: m.player2.name, id: m.player2.id };

                standings[m.player1.id].gamesFor += m.score1;
                standings[m.player1.id].gamesAgainst += m.score2;
                standings[m.player2.id].gamesFor += m.score2;
                standings[m.player2.id].gamesAgainst += m.score1;

                if (m.score1 > m.score2) {
                    standings[m.player1.id].wins++;
                } else {
                    standings[m.player2.id].wins++;
                }
            });
            
            const groups = {};
            Object.values(standings).forEach((playerData) => {
                if (!groups[playerData.group]) groups[playerData.group] = [];
                groups[playerData.group].push(playerData);
            });
            
            let qualified = [];
            Object.values(groups).forEach(groupPlayers => {
                groupPlayers.sort((a, b) => {
                    if (b.wins !== a.wins) return b.wins - a.wins;
                    const diffA = a.gamesFor - a.gamesAgainst;
                    const diffB = b.gamesFor - b.gamesAgainst;
                    if (diffB !== diffA) return diffB - diffA;
                    return b.gamesFor - a.gamesFor;
                });
                qualified.push(...groupPlayers.slice(0, 2));
            });

            qualified.sort((a, b) => {
                if (b.wins !== a.wins) return b.wins - a.wins;
                return (b.gamesFor - b.gamesAgainst) - (a.gamesFor - a.gamesAgainst);
            });
            
            const numQualified = qualified.length;
            if (numQualified < 2) {
                showToast("Não há classificados suficientes para o mata-mata.", "error");
                return;
            }

            const nextPowerOfTwo = Math.pow(2, Math.ceil(Math.log2(numQualified)));
            const byes = nextPowerOfTwo - numQualified;
            
            let bracket = [];
            for (let i = 0; i < byes; i++) {
                bracket.push({ player: qualified[i], bye: true });
            }
            
            let remainingPlayers = qualified.slice(byes);
            let p1_idx = 0;
            let p2_idx = remainingPlayers.length - 1;
            while(p1_idx < p2_idx){
                 bracket.push({
                    p1: remainingPlayers[p1_idx],
                    p2: remainingPlayers[p2_idx]
                });
                p1_idx++;
                p2_idx--;
            }
            shuffleArray(bracket);

            const batch = writeBatch(db);
            generateBracketMatches(bracket, batch, state.currentTournamentId);
            
            batch.update(doc(db, "tournaments", state.currentTournamentId), { status: "Mata-Mata" });
            await batch.commit();
            showToast("Mata-Mata gerado com sucesso!");
        }
        window.generateKnockoutStage = generateKnockoutStage;

        function generateBracketMatches(initialBracket, batch, tId) {
            let currentRoundPlayers = [];
            let roundNumber = 1;
            let matchNumber = 1;
            const roundNames = {16: 'Oitavas de Final', 8: 'Quartas de Final', 4: 'Semifinal', 2: 'Final'};
            let stageName = roundNames[initialBracket.length * 2] || `Rodada ${roundNumber}`;
            
            initialBracket.forEach(matchup => {
                if (matchup.bye) {
                    currentRoundPlayers.push({ winner: matchup.player });
                } else {
                    const matchId = `r${roundNumber}m${matchNumber++}`;
                    batch.set(doc(db, `tournaments/${tId}/matches`, matchId), {
                        player1: {id: matchup.p1.id, name: matchup.p1.name},
                        player2: {id: matchup.p2.id, name: matchup.p2.name},
                        stage: stageName,
                        round: roundNumber,
                        matchNumber: matchNumber - 1,
                        status: 'Pendente',
                        dependsOn: [],
                    });
                    currentRoundPlayers.push(matchId);
                }
            });

            while(currentRoundPlayers.length > 1) {
                roundNumber++;
                stageName = roundNames[currentRoundPlayers.length] || `Rodada ${roundNumber}`;
                let nextRoundPlayers = [];
                for(let i = 0; i < currentRoundPlayers.length; i += 2) {
                    const matchId = `r${roundNumber}m${matchNumber++}`;
                    const dep1 = currentRoundPlayers[i];
                    const dep2 = currentRoundPlayers[i+1];

                    const matchData = {
                        player1: dep1.winner ? dep1.winner : { id: 'A definir', name: 'A definir', from: dep1 },
                        player2: dep2.winner ? dep2.winner : { id: 'A definir', name: 'A definir', from: dep2 },
                        stage: stageName,
                        round: roundNumber,
                        matchNumber: matchNumber - 1,
                        status: 'Pendente',
                        dependsOn: [dep1.winner ? null : dep1, dep2.winner ? null : dep2].filter(Boolean),
                    };
                    batch.set(doc(db, `tournaments/${tId}/matches`, matchId), matchData);
                    nextRoundPlayers.push(matchId);
                }
                currentRoundPlayers = nextRoundPlayers;
            }
        }
        
        async function finishTournament() {
            const confirmed = await showConfirmationModal('Finalizar Torneio?', 'Isso irá calcular e distribuir os pontos para o ranking. Esta ação não pode ser desfeita.');
            if (!confirmed) return;

            const tDoc = await getDoc(doc(db, 'tournaments', state.currentTournamentId));
            if (!tDoc.exists() || !tDoc.data().winner) {
                showToast("A partida final ainda não foi jogada ou o campeão não foi definido.", "error");
                return;
            }

            const pointsSystem = {
                'Final': { winner: 1000, loser: 600 },
                'Semifinal': { loser: 360 },
                'Quartas de Final': { loser: 180 },
                'Oitavas de Final': { loser: 90 },
                'Grupos': { all: 45 },
            };

            const batch = writeBatch(db);
            const playersWithPoints = {}; 
            const matchesSnap = await getDocs(collection(db, `tournaments/${state.currentTournamentId}/matches`));
            
            const allMatches = matchesSnap.docs.map(d => d.data());

            allMatches.filter(m => m.stage === 'Grupos' && m.status === 'Finalizado').forEach(m => {
                if (m.player1.id) playersWithPoints[m.player1.id] = pointsSystem.Grupos.all;
                if (m.player2.id) playersWithPoints[m.player2.id] = pointsSystem.Grupos.all;
            });
            
            const knockoutMatches = allMatches.filter(m => m.stage !== 'Grupos' && m.status === 'Finalizado');
            knockoutMatches.forEach(m => {
                const stagePoints = pointsSystem[m.stage];
                if(!stagePoints) return;

                const winnerId = m.score1 > m.score2 ? m.player1.id : m.player2.id;
                const loserId = m.score1 < m.score2 ? m.player1.id : m.player2.id;
                
                if (stagePoints.winner && winnerId) playersWithPoints[winnerId] = stagePoints.winner;
                if (stagePoints.loser && loserId) playersWithPoints[loserId] = stagePoints.loser;
            });

            for (const [playerId, points] of Object.entries(playersWithPoints)) {
                if (tDoc.data().type === '2x2') {
                    const individualPlayers = playerId.split(' / ');
                    individualPlayers.forEach(p => {
                         const playerRef = doc(db, 'ranking', p);
                         batch.update(playerRef, { points: increment(points) });
                    });
                } else {
                    const playerRef = doc(db, 'ranking', playerId);
                    batch.update(playerRef, { points: increment(points) });
                }
            }

            batch.update(doc(db, "tournaments", state.currentTournamentId), { status: "Finalizado" });
            
            await batch.commit();
            showToast("Torneio finalizado e pontos distribuídos!");
        }
        window.finishTournament = finishTournament;
        
    </script>
</body>
</html>
