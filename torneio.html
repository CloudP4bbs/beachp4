<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Torneios de Beach Tennis V5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .main-tab-button.active { background-color: #3b82f6; color: #ffffff; }
        .admin-tab-button.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        .toast {
            position: fixed; bottom: -100px; left: 50%;
            transform: translateX(-50%); padding: 12px 24px;
            border-radius: 8px; color: white; z-index: 1000;
            opacity: 0; transition: opacity 0.5s, bottom 0.5s;
        }
        .toast.show { opacity: 1; bottom: 30px; }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }

        .bracket-container { overflow-x: auto; padding: 20px 0; }
        .bracket { display: flex; justify-content: flex-start; min-width: max-content; }
        .round { display: flex; flex-direction: column; justify-content: space-around; width: 250px; margin: 0 30px; }
        .round-title { text-align: center; font-size: 1.1rem; font-weight: 700; color: #374151; margin-bottom: 20px; }
        .match { display: flex; flex-direction: column; background-color: white; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); margin: 20px 0; position: relative; }
        .player { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-bottom: 1px solid #e5e7eb; }
        .player:last-child { border-bottom: none; }
        .player-name { font-size: 0.9rem; font-weight: 500; }
        .winner .player-name { font-weight: 700; color: #16a34a; }
        .match-connector { position: absolute; top: 50%; left: 100%; width: 30px; height: 2px; background-color: #d1d5db; }
        .match-connector-line { position: absolute; left: 0; width: 100%; height: 50%; border-color: #d1d5db; }
        .match-connector.up .match-connector-line { top: 0; border-width: 0 2px 2px 0; border-bottom-right-radius: 8px; }
        .match-connector.down .match-connector-line { bottom: 0; border-width: 2px 2px 0 0; border-top-right-radius: 8px; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-6">
        <header class="bg-white rounded-xl shadow-lg p-5 mb-6 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <i class="fas fa-table-tennis text-blue-600 text-4xl"></i>
                <div>
                    <h1 class="text-3xl font-extrabold text-gray-800">Beach Tennis Manager</h1>
                    <p class="text-gray-500">A plataforma completa para seus torneios</p>
                </div>
            </div>
            <div id="auth-container">
                 <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all transform hover:scale-105">
                    <i class="fas fa-user-shield mr-2"></i> Admin Login
                </button>
                <div id="admin-info" class="hidden items-center gap-4">
                    <span id="admin-email" class="font-semibold text-gray-700 hidden sm:inline"></span>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-all transform hover:scale-105">
                        <i class="fas fa-sign-out-alt sm:mr-2"></i> <span class="hidden sm:inline">Logout</span>
                    </button>
                </div>
            </div>
        </header>
        
        <div class="mb-6">
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 bg-white p-2 rounded-xl shadow-md">
                <button onclick="switchMainTab('tournaments')" class="main-tab-button flex items-center justify-center text-center py-3 px-4 rounded-lg font-semibold text-gray-600" data-main-tab="tournaments"><i class="fas fa-trophy mr-2"></i>Torneios</button>
                <button onclick="switchMainTab('ranking')" class="main-tab-button flex items-center justify-center text-center py-3 px-4 rounded-lg font-semibold text-gray-600" data-main-tab="ranking"><i class="fas fa-star mr-2"></i>Ranking</button>
                <button id="admin-main-tab" onclick="switchMainTab('admin')" class="main-tab-button md:col-auto col-span-2 flex items-center justify-center text-center py-3 px-4 rounded-lg font-semibold text-gray-600 hidden" data-main-tab="admin"><i class="fas fa-cogs mr-2"></i>Painel Admin</button>
            </div>
        </div>
        <main id="main-content"></main>
    </div>
    <div id="modal-container"></div>
    <div id="toast-container"></div>
    
    <!-- Templates -->
    <template id="tournaments-view-template">
        <div id="tournaments-list-container">
            <h2 class="text-3xl font-bold mb-6 text-gray-700">Torneios Ativos</h2>
            <div id="user-tournaments-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <p id="no-tournaments-msg" class="text-gray-500 mt-4 hidden">Nenhum torneio encontrado.</p>
        </div>
        <div id="user-tournament-details" class="bg-white rounded-xl shadow-lg p-4 sm:p-6 hidden"></div>
    </template>
    
    <template id="ranking-view-template">
        <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
            <h2 class="text-3xl font-bold mb-6 text-gray-700">Ranking Geral de Atletas</h2>
            <div class="overflow-x-auto"><table class="min-w-full bg-white"><thead class="bg-gray-800 text-white"><tr><th class="w-1/12 text-left py-3 px-4 uppercase font-semibold text-sm rounded-tl-lg">#</th><th class="w-8/12 text-left py-3 px-4 uppercase font-semibold text-sm">Atleta</th><th class="w-3/12 text-left py-3 px-4 uppercase font-semibold text-sm rounded-tr-lg">Pontos</th></tr></thead><tbody id="ranking-table-body" class="text-gray-700"></tbody></table></div>
        </div>
    </template>
    
    <template id="admin-view-template">
        <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
            <div class="border-b border-gray-200 mb-6"><nav class="-mb-px flex flex-wrap space-x-8" aria-label="Tabs"><button onclick="switchAdminTab('tournaments')" class="admin-tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-admin-tab="tournaments"><i class="fas fa-trophy mr-2"></i>Torneios</button><button onclick="switchAdminTab('athletes')" class="admin-tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-admin-tab="athletes"><i class="fas fa-users mr-2"></i>Atletas</button><button onclick="switchAdminTab('enrollments')" class="admin-tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-admin-tab="enrollments"><i class="fas fa-user-plus mr-2"></i>Inscrições</button><button onclick="switchAdminTab('matches')" class="admin-tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-admin-tab="matches"><i class="fas fa-table-tennis mr-2"></i>Partidas</button></nav></div>
            <div id="admin-content-area"></div>
        </div>
    </template>

    <template id="admin-tournaments-content-template">
         <h3 class="text-2xl font-bold mb-4">Criar Novo Torneio</h3>
         <form id="create-tournament-form" class="space-y-4 bg-gray-50 p-6 rounded-lg border"><input type="text" id="tournament-name" placeholder="Nome do Torneio" class="w-full p-3 border rounded-md" required><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><select id="tournament-type" class="w-full p-3 border rounded-md"><option value="1x1">Simples (1x1)</option><option value="2x2">Duplas (2x2)</option></select><select id="tournament-category" class="w-full p-3 border rounded-md"><option value="A">Cat. A</option><option value="B">Cat. B</option><option value="C">Cat. C</option><option value="D">Cat. D</option></select><select id="tournament-age" class="w-full p-3 border rounded-md"><option value="Adulto">Adulto</option><option value="Infantil">Infantil</option></select><select id="tournament-gender" class="w-full p-3 border rounded-md"><option value="Masculino">Masculino</option><option value="Feminino">Feminino</option><option value="Misto">Misto</option></select></div><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md">Criar Torneio</button></form>
         <h3 class="text-2xl font-bold mt-8 mb-4">Torneios Existentes</h3>
         <div id="admin-tournaments-list" class="space-y-3"></div>
    </template>
    
    <template id="admin-athletes-content-template">
        <h3 class="text-2xl font-bold mb-4">Gerenciar Atletas (Banco de Dados Global)</h3>
        <form id="add-athlete-form" class="space-y-4 bg-gray-50 p-6 rounded-lg border mb-8"><label for="athlete-name" class="block font-medium">Nome do Atleta Individual</label><input type="text" id="athlete-name" placeholder="Ex: João Silva" class="w-full p-3 border rounded-md" required><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md">Adicionar à Lista</button></form>
        <h4 class="text-xl font-bold mt-6 mb-2">Lista de Atletas</h4>
        <div id="global-athletes-list" class="space-y-2"></div>
    </template>

    <template id="admin-enrollments-content-template">
        <h3 class="text-2xl font-bold mb-4">Inscrições nos Torneios</h3>
        <div class="space-y-4 bg-gray-50 p-6 rounded-lg border"><label for="enrollment-tournament-select" class="block font-medium">Selecione um Torneio:</label><select id="enrollment-tournament-select" class="w-full p-3 border rounded-md"></select></div>
        <div id="enrollment-management-area" class="mt-6 hidden">
            <div id="enrollment-form-container"></div>
            <h4 class="text-xl font-bold mt-8 mb-4">Inscritos no Torneio</h4>
            <div id="enrolled-list" class="space-y-2"></div>
        </div>
    </template>

    <template id="admin-matches-content-template">
         <h3 class="text-2xl font-bold mb-4">Gerenciar Partidas</h3>
         <div class="space-y-4 bg-gray-50 p-6 rounded-lg border"><label for="match-tournament-select" class="block font-medium">Selecione um Torneio:</label><select id="match-tournament-select" class="w-full p-3 border rounded-md"></select></div>
         <div id="match-management-area" class="mt-6 hidden"><div id="tournament-controls" class="flex justify-center gap-4 mb-6"></div><div id="matches-list-container" class="space-y-6"></div></div>
    </template>
    
    <template id="auth-modal-template">
        <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4" id="auth-modal">
            <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md"><div class="flex justify-between items-start mb-6"><h3 id="auth-title" class="text-2xl font-bold">Admin Login</h3><button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div><form id="login-form"><input type="email" id="login-email-input" class="w-full p-3 border-gray-300 border rounded-md mb-4" placeholder="Email" required><input type="password" id="login-password-input" class="w-full p-3 border-gray-300 border rounded-md mb-4" placeholder="Senha" required><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Entrar</button></form><p id="auth-error" class="text-red-500 text-sm mt-4 text-center h-4"></p></div>
        </div>
    </template>

    <template id="score-modal-template">
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md"><h3 class="text-xl font-bold mb-6">Atualizar Placar</h3><form id="update-score-form"><input type="hidden" id="modal-tournament-id"><input type="hidden" id="modal-match-id"><input type="hidden" id="modal-match-stage"><div class="grid grid-cols-2 gap-4 items-end"><div class="text-center"><label id="player1-name-label" class="block font-semibold mb-2"></label><input type="number" id="player1-score" class="w-full p-3 text-center text-2xl font-bold border rounded-md" min="0" required></div><div class="text-center"><label id="player2-name-label" class="block font-semibold mb-2"></label><input type="number" id="player2-score" class="w-full p-3 text-center text-2xl font-bold border rounded-md" min="0" required></div></div><div class="mt-8 flex justify-end space-x-4"><button type="button" onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Salvar Placar</button></div></form></div></div>
    </template>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, onSnapshot, deleteDoc, updateDoc, query, where, getDoc, writeBatch, serverTimestamp, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDEiEknWaOl2ra-it2dB8mFGPb9-Q__5-E",
          authDomain: "beachp4-70588.firebaseapp.com",
          projectId: "beachp4-70588",
          storageBucket: "beachp4-70588.appspot.com",
          messagingSenderId: "960018980292",
          appId: "1:960018980292:web:a11dbdd40811dec1ee5891"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let unsubscribes = [];
        const mainContent = document.getElementById('main-content');
        const modalContainer = document.getElementById('modal-container');
        
        // ---- HELPERS & CORE ----
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        };

        const clearListeners = () => {
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];
        };

        const attachListener = (id, event, handler) => {
            const el = document.getElementById(id);
            if (el) el.addEventListener(event, handler);
        };
        
        window.closeModal = () => { modalContainer.innerHTML = ''; };

        // ---- AUTH ----
        onAuthStateChanged(auth, (user) => {
            document.getElementById('admin-info').classList.toggle('hidden', !user);
            document.getElementById('admin-info').classList.toggle('flex', !!user);
            document.getElementById('login-btn').classList.toggle('hidden', !!user);
            document.getElementById('admin-main-tab').classList.toggle('hidden', !user);
            if(user) document.getElementById('admin-email').textContent = user.email;
            if(!user && document.querySelector('.main-tab-button.active')?.dataset.mainTab === 'admin') switchMainTab('tournaments');
        });
        document.getElementById('login-btn').addEventListener('click', () => {
            modalContainer.innerHTML = document.getElementById('auth-modal-template').innerHTML;
            attachListener('login-form', 'submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email-input').value;
                const password = document.getElementById('login-password-input').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    closeModal();
                } catch (error) { document.getElementById('auth-error').textContent = "Email ou senha inválidos."; }
            });
        });
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // ---- NAVIGATION ----
        window.switchMainTab = (tabName) => {
            document.querySelectorAll('.main-tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.main-tab-button[data-main-tab='${tabName}']`).classList.add('active');
            clearListeners();
            const views = {
                tournaments: renderTournamentsView,
                ranking: renderRankingView,
                admin: renderAdminView
            };
            views[tabName]();
        };

        window.switchAdminTab = (tabName) => {
            document.querySelectorAll('.admin-tab-button').forEach(btn => btn.classList.remove('active', 'text-blue-600', 'border-blue-600'));
            const activeBtn = document.querySelector(`.admin-tab-button[data-admin-tab='${tabName}']`);
            if(activeBtn) activeBtn.classList.add('active', 'text-blue-600', 'border-blue-600');
            
            clearListeners();
            const contentArea = document.getElementById('admin-content-area');
            if (!contentArea) return;
            contentArea.innerHTML = document.getElementById(`admin-${tabName}-content-template`).innerHTML;
            const setups = {
                tournaments: setupAdminTournamentsTab,
                athletes: setupAdminAthletesTab,
                enrollments: setupAdminEnrollmentsTab,
                matches: setupAdminMatchesTab,
            };
            setups[tabName]();
        };

        // ---- MAIN VIEWS ----
        function renderTournamentsView() {
            mainContent.innerHTML = document.getElementById('tournaments-view-template').innerHTML;
            const unsub = onSnapshot(query(collection(db, "tournaments"), orderBy("createdAt", "desc")), (snapshot) => {
                const listEl = document.getElementById('user-tournaments-list');
                if(!listEl) return;
                listEl.innerHTML = '';
                document.getElementById('no-tournaments-msg').classList.toggle('hidden', !snapshot.empty);
                snapshot.forEach(doc => listEl.innerHTML += createUserTournamentCard(doc.id, doc.data()));
            });
            unsubscribes.push(unsub);
        };
        function renderRankingView() {
            mainContent.innerHTML = document.getElementById('ranking-view-template').innerHTML;
            const unsub = onSnapshot(query(collection(db, "ranking"), orderBy("points", "desc")), (snapshot) => {
                const tableBody = document.getElementById('ranking-table-body');
                if(!tableBody) return;
                tableBody.innerHTML = '';
                snapshot.forEach((doc, i) => tableBody.innerHTML += `<tr><td class="py-3 px-4 font-bold">${i+1}</td><td class="py-3 px-4">${doc.id}</td><td class="py-3 px-4 font-semibold">${doc.data().points}</td></tr>`);
            });
            unsubscribes.push(unsub);
        };
        function renderAdminView() {
            mainContent.innerHTML = document.getElementById('admin-view-template').innerHTML;
            switchAdminTab('tournaments');
        };

        // ---- ADMIN: TOURNAMENTS ----
        function setupAdminTournamentsTab() {
            attachListener('create-tournament-form', 'submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                try {
                    await addDoc(collection(db, "tournaments"), {
                        name: form.querySelector('#tournament-name').value,
                        type: form.querySelector('#tournament-type').value,
                        category: form.querySelector('#tournament-category').value,
                        age: form.querySelector('#tournament-age').value,
                        gender: form.querySelector('#tournament-gender').value,
                        status: 'Inscrições Abertas',
                        createdAt: serverTimestamp()
                    });
                    form.reset();
                    showToast("Torneio criado com sucesso!");
                } catch (error) { showToast("Erro ao criar torneio.", "error"); }
            });
            const unsub = onSnapshot(query(collection(db, "tournaments"), orderBy("createdAt", "desc")), (snapshot) => {
                const listEl = document.getElementById('admin-tournaments-list');
                if(listEl) listEl.innerHTML = snapshot.docs.map(doc => createAdminTournamentCard(doc.id, doc.data())).join('');
            });
            unsubscribes.push(unsub);
        };
        window.deleteTournament = async (id) => {
            if (confirm("Tem certeza? Todos os dados serão apagados.")) {
                await deleteDoc(doc(db, "tournaments", id));
                showToast("Torneio apagado.");
            }
        };

        // ---- ADMIN: ATHLETES ----
        function setupAdminAthletesTab() {
            attachListener('add-athlete-form', 'submit', async (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('athlete-name');
                const name = nameInput.value.trim();
                if (!name) return;
                try {
                    await setDoc(doc(db, "athletes", name), { name });
                    nameInput.value = '';
                    showToast("Atleta adicionado!");
                } catch (error) { showToast("Erro ao adicionar atleta.", "error"); }
            });
            const unsub = onSnapshot(query(collection(db, "athletes"), orderBy("name")), (snapshot) => {
                const listEl = document.getElementById('global-athletes-list');
                if(listEl) listEl.innerHTML = snapshot.docs.map(doc => createGlobalAthleteItem(doc.id, doc.data())).join('');
            });
            unsubscribes.push(unsub);
        };
        window.deleteGlobalAthlete = async (name) => {
            if (confirm(`Remover "${name}" da lista global?`)) {
                await deleteDoc(doc(db, "athletes", name));
                showToast("Atleta removido.");
            }
        };
        
        // ---- ADMIN: ENROLLMENTS ----
        function setupAdminEnrollmentsTab() {
            const selectEl = document.getElementById('enrollment-tournament-select');
            loadTournamentsIntoSelect(selectEl, false, () => {
                selectEl.addEventListener('change', async (e) => {
                    const tournamentId = e.target.value;
                    document.getElementById('enrollment-management-area').classList.toggle('hidden', !tournamentId);
                    if (tournamentId) {
                        const tournamentDoc = await getDoc(doc(db, "tournaments", tournamentId));
                        listenToEnrollments(tournamentId, tournamentDoc.data().type);
                    }
                });
            });
        };
        
        function listenToEnrollments(tournamentId, tournamentType) {
            const formContainer = document.getElementById('enrollment-form-container');
            const enrolledListEl = document.getElementById('enrolled-list');
            
            const unsub1 = onSnapshot(collection(db, "athletes"), (allAthletesSnap) => {
                const unsub2 = onSnapshot(collection(db, `tournaments/${tournamentId}/players`), (enrolledAthletesSnap) => {
                    if (!formContainer || !enrolledListEl) return;
                    
                    const allAthletes = allAthletesSnap.docs.map(d => d.id);
                    const enrolledData = enrolledAthletesSnap.docs.map(d => ({id: d.id, ...d.data()}));
                    
                    let enrolledIndividuals = [];
                    enrolledData.forEach(p => {
                        if (p.type === 'single') enrolledIndividuals.push(p.id);
                        else if (p.type === 'double') enrolledIndividuals.push(...p.players);
                    });
                    
                    const availableAthletes = allAthletes.filter(name => !enrolledIndividuals.includes(name));
                    let options = availableAthletes.map(name => `<option value="${name}">${name}</option>`).join('');
                    
                    if (tournamentType === '1x1') {
                        formContainer.innerHTML = `<form id="enroll-single-form" class="flex gap-2"><select class="w-full p-3 border rounded-md">${options}</select><button type="submit" class="bg-blue-500 text-white px-4 rounded-md">Inscrever</button></form>`;
                        attachListener('enroll-single-form', 'submit', e => {
                            e.preventDefault();
                            const selectedName = e.target.querySelector('select').value;
                            if(selectedName) enrollSinglePlayer(tournamentId, selectedName);
                        });
                    } else {
                        formContainer.innerHTML = `<form id="enroll-double-form" class="space-y-2"><p>Selecione dois atletas para formar uma dupla:</p><select id="p1" class="w-full p-3 border rounded-md">${options}</select><select id="p2" class="w-full p-3 border rounded-md">${options}</select><button type="submit" class="w-full bg-blue-500 text-white p-3 rounded-md">Formar Dupla e Inscrever</button></form>`;
                        attachListener('enroll-double-form', 'submit', e => {
                            e.preventDefault();
                            const p1 = e.target.querySelector('#p1').value;
                            const p2 = e.target.querySelector('#p2').value;
                            if(p1 && p2 && p1 !== p2) enrollDoublePlayer(tournamentId, p1, p2);
                            else showToast("Selecione dois atletas diferentes.", "error");
                        });
                    }
                    enrolledListEl.innerHTML = enrolledData.map(player => createEnrolledItem(tournamentId, player.id)).join('');
                });
                unsubscribes.push(unsub2);
            });
            unsubscribes.push(unsub1);
        };
        async function enrollSinglePlayer(tournamentId, playerName) {
            await setDoc(doc(db, `tournaments/${tournamentId}/players`, playerName), { name: playerName, type: 'single' });
        };
        async function enrollDoublePlayer(tournamentId, p1, p2) {
            const pairName = [p1, p2].sort().join(' / ');
            await setDoc(doc(db, `tournaments/${tournamentId}/players`, pairName), { name: pairName, type: 'double', players: [p1, p2] });
        };
        window.unenroll = async (tournamentId, playerId) => {
            await deleteDoc(doc(db, `tournaments/${tournamentId}/players`, playerId));
        };

        // ---- ADMIN: MATCHES & GAME LOGIC ----
        function setupAdminMatchesTab() {
             const selectEl = document.getElementById('match-tournament-select');
            loadTournamentsIntoSelect(selectEl, true, () => {
                selectEl.addEventListener('change', (e) => {
                    const tournamentId = e.target.value;
                    document.getElementById('match-management-area').classList.toggle('hidden', !tournamentId);
                    if (tournamentId) listenToTournamentState(tournamentId);
                });
            });
        };
        function listenToTournamentState(tournamentId) {
            unsubscribes.push(onSnapshot(doc(db, "tournaments", tournamentId), (d) => {
                if(!d.exists()) return;
                renderTournamentControls(tournamentId, d.data().status);
                renderMatchesList(tournamentId, d.data().status);
            }));
        };
        window.generateGroupStage = async (id) => {
            if (!confirm('Gerar fase de grupos? Inscrições serão encerradas.')) return;
            const snap = await getDocs(collection(db, `tournaments/${id}/players`));
            const players = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            if (players.length < 3) { alert('Mínimo de 3 inscritos.'); return; }
            const groups = generateGroups(players);
            const matches = generateGroupMatches(groups);
            const batch = writeBatch(db);
            matches.forEach(m => batch.set(doc(collection(db, `tournaments/${id}/matches`)), m));
            batch.update(doc(db, "tournaments", id), { status: "Fase de Grupos" });
            await batch.commit();
            showToast("Fase de grupos gerada!");
        };
        window.generateKnockoutStage = async (id) => {
            if (!confirm('Gerar mata-mata? A fase de grupos será finalizada.')) return;
            const groupMatches = await getDocs(query(collection(db, `tournaments/${id}/matches`), where("stage", "==", "Grupos")));
            if (!groupMatches.docs.every(d => d.data().status === 'Finalizado')) { alert('Finalize todas as partidas de grupo.'); return; }
            
            const qualified = getQualifiedPlayers(calculateGroupStandings(groupMatches.docs));
            const stage = qualified.length <= 2 ? 'Final' : qualified.length <= 4 ? 'Semifinal' : 'Quartas';
            if(qualified.length > 8) { alert('Máximo de 8 qualificados para o mata-mata.'); return;}

            const knockoutMatches = createKnockoutBracket(qualified, stage);
            const batch = writeBatch(db);
            let matchRefs = {};
            knockoutMatches.forEach(match => {
                const matchRef = doc(collection(db, `tournaments/${id}/matches`));
                batch.set(matchRef, match);
                if(!matchRefs[match.stage]) matchRefs[match.stage] = [];
                matchRefs[match.stage].push(matchRef.id);
            });
            let currentRoundIds = matchRefs[stage];
            let currentStage = stage;
            while(currentRoundIds.length > 1) {
                const nextStageName = currentStage === 'Quartas' ? 'Semifinal' : 'Final';
                if(!matchRefs[nextStageName]) matchRefs[nextStageName] = [];
                for(let i = 0; i < currentRoundIds.length; i+=2) {
                    const ref = doc(collection(db, `tournaments/${id}/matches`));
                    batch.set(ref, {
                        player1: {id:'A definir', name:'A definir'}, player2:{id:'A definir', name:'A definir'},
                        score1:null, score2:null, status:'Pendente', stage: nextStageName,
                        dependsOn: [currentRoundIds[i], currentRoundIds[i+1] || null]
                    });
                    matchRefs[nextStageName].push(ref.id);
                }
                currentStage = nextStageName;
                currentRoundIds = matchRefs[currentStage];
            }
            batch.update(doc(db, "tournaments", id), { status: "Mata-Mata" });
            await batch.commit();
            showToast("Mata-mata gerado!");
        };
        window.finishTournament = async (id) => {
             if (!confirm('Finalizar torneio e distribuir pontos?')) return;
             const final = await getDocs(query(collection(db, `tournaments/${id}/matches`), where("stage", "==", "Final")));
             if (final.empty || final.docs[0].data().status !== 'Finalizado') { alert('Final não concluída.'); return; }
             const match = final.docs[0].data();
             const winner = match.score1 > match.score2 ? match.player1 : match.player2;
             const loser = match.score1 < match.score2 ? match.player1 : match.player2;
             const playersToUpdate = [];
             if(winner.type === 'double') playersToUpdate.push(...winner.players.map(p => ({name: p, points: 100}))); else playersToUpdate.push({name: winner.name, points: 100});
             if(loser.type === 'double') playersToUpdate.push(...loser.players.map(p => ({name: p, points: 50}))); else playersToUpdate.push({name: loser.name, points: 50});
             for(const p of playersToUpdate) await updateRanking(p.name, p.points);
             await updateDoc(doc(db, "tournaments", id), { status: "Finalizado", winner: winner.name });
             showToast("Torneio finalizado!");
        };
        const updateRanking = async (playerName, points) => {
            if (!playerName || playerName === 'BYE' || playerName === 'A definir') return;
            const ref = doc(db, "ranking", playerName);
            const d = await getDoc(ref);
            await setDoc(ref, { points: (d.exists() ? d.data().points : 0) + points, name: playerName });
        };
        
        window.openScoreModal = (tId, mId, stage, p1, p2) => {
            modalContainer.innerHTML = document.getElementById('score-modal-template').innerHTML;
            document.getElementById('modal-tournament-id').value = tId;
            document.getElementById('modal-match-id').value = mId;
            document.getElementById('modal-match-stage').value = stage;
            document.getElementById('player1-name-label').innerText = p1;
            document.getElementById('player2-name-label').innerText = p2;
            attachListener('update-score-form', 'submit', updateScore);
        };
        const updateScore = async (e) => {
            e.preventDefault();
            const s1 = parseInt(document.getElementById('player1-score').value);
            const s2 = parseInt(document.getElementById('player2-score').value);
            if (s1 === s2) { alert("Empates não são permitidos."); return; }
            const tId = document.getElementById('modal-tournament-id').value;
            const mId = document.getElementById('modal-match-id').value;
            const stage = document.getElementById('modal-match-stage').value;
            await updateDoc(doc(db, `tournaments/${tId}/matches`, mId), { score1: s1, score2: s2, status: 'Finalizado' });
            if (stage !== 'Grupos') await advanceWinner(tId, mId);
            closeModal();
        };
        const advanceWinner = async (tId, mId) => {
            const matchDoc = await getDoc(doc(db, `tournaments/${tId}/matches`, mId));
            if(!matchDoc.exists()) return;
            const d = matchDoc.data(), winner = d.score1 > d.score2 ? d.player1 : d.player2;
            const q = query(collection(db, `tournaments/${tId}/matches`), where("dependsOn", "array-contains", mId));
            const nextSnap = await getDocs(q);
            if (!nextSnap.empty) {
                const nextDoc = nextSnap.docs[0];
                const update = nextDoc.data().player1.id === 'A definir' ? { player1: winner } : { player2: winner };
                await updateDoc(doc(db, `tournaments/${tId}/matches`, nextDoc.id), update);
            }
        };

        // ---- UI COMPONENT RENDERERS ----
        const createUserTournamentCard = (id, d) => `<div onclick="showTournamentDetails('${id}')" class="bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all cursor-pointer"><div class="flex justify-between items-start"><h3 class="font-bold text-xl mb-2 text-blue-800">${d.name}</h3><span class="text-xs font-semibold px-2.5 py-1 rounded-full ${getStatusInfo(d.status).style}">${d.status}</span></div><p class="text-gray-600 text-sm"><i class="fas fa-tags mr-2 opacity-60"></i>${d.category}/${d.gender}/${d.age}</p><p class="text-gray-600 text-sm"><i class="fas fa-info-circle mr-2 opacity-60"></i>${d.type}</p></div>`;
        const createAdminTournamentCard = (id, d) => `<div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg border"><div><p class="font-semibold">${d.name}</p><p class="text-sm text-gray-600">${d.status}</p></div><button onclick="deleteTournament('${id}')" class="text-red-500 hover:text-red-700 font-bold p-1"><i class="fas fa-trash"></i></button></div>`;
        const createGlobalAthleteItem = (id, d) => `<div class="flex justify-between items-center bg-white p-2 rounded shadow-sm border"><span>${d.name}</span><button onclick="deleteGlobalAthlete('${id}')" class="text-red-500 hover:text-red-700 text-sm p-1"><i class="fas fa-trash"></i></button></div>`;
        const createEnrolledItem = (tId, pId) => `<div class="flex justify-between items-center bg-white p-2 rounded shadow-sm border"><span>${pId}</span><button onclick="unenroll('${tId}', '${pId}')" class="text-red-500 hover:text-red-700 text-sm p-1"><i class="fas fa-minus-circle"></i></button></div>`;
        const renderTournamentControls = (id, status) => {
            const c = document.getElementById('tournament-controls'); if(!c) return;
            const buttons = {
                'Inscrições Abertas': `<button onclick="generateGroupStage('${id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg">Iniciar Fase de Grupos</button>`,
                'Fase de Grupos': `<button onclick="generateKnockoutStage('${id}')" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg">Iniciar Mata-Mata</button>`,
                'Mata-Mata': `<button onclick="finishTournament('${id}')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg">Finalizar Torneio</button>`,
                'Finalizado': `<p class="text-center font-semibold text-green-700">Torneio Finalizado.</p>`
            };
            c.innerHTML = buttons[status] || '';
        };

        // ---- GAME LOGIC ----
        const getGroupFormation = (n)=>{const f={3:{g:1,p:[3]},4:{g:1,p:[4]},5:{g:1,p:[5]},6:{g:2,p:[3,3]},7:{g:2,p:[4,3]},8:{g:2,p:[4,4]},9:{g:3,p:[3,3,3]},10:{g:3,p:[4,3,3]},11:{g:3,p:[4,4,3]},12:{g:4,p:[3,3,3,3]},13:{g:4,p:[4,3,3,3]},14:{g:4,p:[4,4,3,3]},15:{g:5,p:[3,3,3,3,3]},16:{g:5,p:[4,3,3,3,3]}};return f[n]||null;};
        const generateGroups=(p)=>{let s=[...p].sort(()=>.5-Math.random()),f=getGroupFormation(s.length);if(!f)return[];const g=[];let idx=0;for(let i=0;i<f.g;i++){g.push({name:`Grupo ${String.fromCharCode(65+i)}`,players:s.slice(idx,idx+f.p[i])});idx+=f.p[i];}return g;};
        const generateGroupMatches=(g)=>{const m=[];g.forEach(gr=>{for(let i=0;i<gr.players.length;i++)for(let j=i+1;j<gr.players.length;j++)m.push({group:gr.name,player1:gr.players[i],player2:gr.players[j],score1:null,score2:null,status:'Pendente',stage:'Grupos'});});return m;};
        const calculateGroupStandings=(docs)=>{const s={},g={};docs.forEach(d=>{const m=d.data();[m.player1,m.player2].forEach(p=>{if(!s[p.name])s[p.name]={name:p.name,V:0,SG:0,GG:0};});if(!g[m.group])g[m.group]=[];if(!g[m.group].includes(m.player1.name))g[m.group].push(m.player1.name);if(!g[m.group].includes(m.player2.name))g[m.group].push(m.player2.name);if(m.status!=='Finalizado')return;s[m.player1.name].V+=(m.score1>m.score2?1:0);s[m.player2.name].V+=(m.score2>m.score1?1:0);s[m.player1.name].SG+=m.score1-m.score2;s[m.player2.name].SG+=m.score2-m.score1;s[m.player1.name].GG+=m.score1;s[m.player2.name].GG+=m.score2;});Object.keys(g).forEach(n=>{g[n].sort((a,b)=>(s[b].V-s[a].V)||(s[b].SG-s[a].SG)||(s[b].GG-s[a].GG));});return {playerStats:s,sortedGroups:g};};
        const getQualifiedPlayers=(standings)=>{const q=[],s=standings.playerStats;Object.values(standings.sortedGroups).forEach(g=>{if(g[0])q.push(s[g[0]]);if(g[1])q.push(s[g[1]]);});q.sort((a,b)=>(b.V-a.V)||(b.SG-a.SG)||(b.GG-a.GG));return q;};
        const createKnockoutBracket=(p,stage)=>{let size=stage==='Final'?2:stage==='Semifinal'?4:8;while(p.length<size)p.push({id:'BYE',name:'BYE'});const m=[],s=[0,7,3,4,2,5,1,6].slice(0,size);for(let i=0;i<size/2;i++){const p1=p[s[i*2]]||{id:'BYE',name:'BYE'},p2=p[s[i*2+1]]||{id:'BYE',name:'BYE'},match={player1:p1,player2:p2,score1:null,score2:null,status:'Pendente',stage,round:1};if(p1.id==='BYE'){match.status='Finalizado';match.score1=0;match.score2=1;}if(p2.id==='BYE'){match.status='Finalizado';match.score1=1;match.score2=0;}m.push(match);}return m;};

        // ---- PUBLIC VIEWS ----
        window.showTournamentDetails = (id) => {
            document.getElementById('tournaments-list-container').style.display = 'none';
            const view = document.getElementById('user-tournament-details');
            view.style.display = 'block';
            view.innerHTML = `<div class="text-center p-10"><i class="fas fa-spinner fa-spin text-3xl"></i></div>`;
            const unsub = onSnapshot(doc(db, "tournaments", id), (d) => {
                if (!d.exists() || !view.parentNode) return;
                const t = d.data(), s = getStatusInfo(t.status);
                view.innerHTML = `<button onclick="switchMainTab('tournaments')" class="mb-6 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg"><i class="fas fa-arrow-left mr-2"></i>Voltar</button><div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-extrabold">${t.name}</h2><span class="text-sm font-semibold px-3 py-1.5 rounded-full ${s.style}">${s.text}</span></div>${t.status==='Finalizado'&&t.winner?`<div class="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-6"><p class="font-bold"><i class="fas fa-crown mr-2"></i>Campeão: ${t.winner}</p></div>`:''}<div id="tournament-content-area"></div>`;
                listenToTournamentMatches(id, t.status);
            });
            unsubscribes.push(unsub);
        };
        const listenToTournamentMatches = (id, status) => {
            const unsub = onSnapshot(query(collection(db,`tournaments/${id}/matches`),orderBy("stage")), (snap) => {
                const area = document.getElementById('tournament-content-area');
                if(!area) return;
                if (snap.empty) { area.innerHTML = '<p>Partidas não geradas.</p>'; return; }
                const matches = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                area.innerHTML = (status === 'Mata-Mata' || status === 'Finalizado') ? renderBracketView(matches) : renderGroupStageView(matches);
            });
            unsubscribes.push(unsub);
        };
        const renderGroupStageView = (matches) => {
            const groups = {};
            matches.forEach(m => { if (!groups[m.group]) groups[m.group] = []; groups[m.group].push(m); });
            let html = '<h3 class="text-2xl font-bold mb-4">Fase de Grupos</h3>';
            Object.keys(groups).sort().forEach(name => {
                html += `<div class="mb-6"><h4 class="text-xl font-bold p-3 bg-blue-100 text-blue-800 rounded-t-lg">${name}</h4><div class="border rounded-b-lg p-4 space-y-3">`;
                groups[name].forEach(m => {
                    const score = m.status==='Finalizado'?`<span class="font-bold">${m.score1} x ${m.score2}</span>`:`<span>Pendente</span>`;
                    html += `<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50"><div>${m.player1.name} vs ${m.player2.name}</div><div>${score}</div></div>`;
                });
                html += `</div></div>`;
            });
            return html;
        };
        const renderBracketView = (matches) => {
             const rounds = { 'Quartas': [], 'Semifinal': [], 'Final': [] };
             matches.forEach(m => { if (rounds[m.stage]) rounds[m.stage].push(m); });
             let html = '<h3 class="text-2xl font-bold mb-4">Mata-Mata</h3><div class="bracket-container"><div class="bracket">';
             Object.keys(rounds).forEach(name => {
                 if(rounds[name].length === 0) return;
                 html += `<div class="round"><div class="round-title">${name}</div>`;
                 rounds[name].forEach((m, i) => {
                     const p1Win = m.score1 > m.score2, p2Win = m.score2 > m.score1;
                     html += `<div class="match"><div class="match-content"><div class="player ${p1Win?'winner':''}"><span class="player-name">${m.player1.name}</span><span class="player-score">${m.score1??''}</span></div><div class="player ${p2Win?'winner':''}"><span class="player-name">${m.player2.name}</span><span class="player-score">${m.score2??''}</span></div></div>${name!=='Final'?`<div class="match-connector ${i%2===0?'up':'down'}"><div class="match-connector-line"></div></div>`:''}</div>`;
                 });
                 html += `</div>`;
             });
             return html + '</div></div>';
        };
        const renderMatchesList = (id, status) => {
            const list = document.getElementById('matches-list-container'); if(!list) return;
            const unsub = onSnapshot(query(collection(db,`tournaments/${id}/matches`)), (snap) => {
                list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<p>Nenhuma partida gerada.</p>'; return; }
                const matches=snap.docs.map(d=>({id:d.id,...d.data()})), hasKO=matches.some(m=>m.stage!=='Grupos');
                if(hasKO){const r={'Quartas':[],'Semifinal':[],'Final':[]};matches.filter(m=>m.stage!=='Grupos').forEach(m=>{if(r[m.stage])r[m.stage].push(m);});Object.keys(r).forEach(n=>{if(r[n].length>0)list.innerHTML+=createMatchListSection(id,n,r[n],status);});}
                else{const g={};matches.forEach(m=>{if(!g[m.group])g[m.group]=[];g[m.group].push(m);});Object.keys(g).sort().forEach(n=>{list.innerHTML+=createMatchListSection(id,n,g[n],status);});}
            });
            unsubscribes.push(unsub);
        };
        const createMatchListSection = (id, title, matches, tStatus) => {
            let html = `<h4 class="text-xl font-bold mt-4 mb-2 p-3 bg-gray-200 rounded-lg">${title}</h4>`;
            matches.forEach(m => {
                const score = m.status==='Finalizado'?`<b>${m.score1} x ${m.score2}</b>`:'Pendente';
                const canUpdate = tStatus!=='Finalizado'&&m.player1.id!=='A definir'&&m.player2.id!=='A definir'&&m.player1.id!=='BYE'&&m.player2.id!=='BYE';
                html += `<div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border"><div><span>${m.player1.name} vs ${m.player2.name}</span><span class="ml-4 text-sm font-semibold">${score}</span></div>${canUpdate?`<button onclick="openScoreModal('${id}','${m.id}','${m.stage}','${m.player1.name}','${m.player2.name}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">Placar</button>`:''}</div>`;
            });
            return html;
        };
        
        async function loadTournamentsIntoSelect(selectEl, all = false, callback) {
            let q = collection(db, "tournaments");
            if (!all) {
                q = query(q, where("status", "==", "Inscrições Abertas"));
            }
            q = query(q, orderBy("createdAt", "desc"));
            
            const snapshot = await getDocs(q);
            selectEl.innerHTML = '<option value="">Selecione um torneio...</option>';
            snapshot.forEach((doc) => {
                selectEl.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`;
            });
            if (callback) callback();
        }

        // ---- INITIALIZATION ----
        switchMainTab('tournaments');

    </script>
</body>
</html>
